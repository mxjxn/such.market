# Such.Market - Complete LLM Documentation

## Overview

Such.Market is a Farcaster Mini App for trading NFTs on Base. Built with Next.js 14, TypeScript, Supabase, and Upstash Redis. The application features advanced caching, smart profile prioritization, notifications, and Seaport integration for NFT trading.

## Architecture

### Tech Stack
- **Frontend**: Next.js 14 (App Router), React, TypeScript, Tailwind CSS
- **Backend**: Next.js API Routes
- **Database**: Supabase (PostgreSQL)
- **Caching**: Upstash Redis with hierarchical strategy (L1/L2/L3)
- **Blockchain**: Base, Alchemy SDK, Seaport protocol
- **Authentication**: Farcaster (via Neynar), NextAuth

### Key Design Decisions

1. **Collection-Level Engagement Tracking**: Instead of tracking individual NFT views (which would be billions of records), we track at the collection level. This provides better signals and scales efficiently.

2. **Smart Profile Prioritization**: User profiles prioritize collections based on:
   - User's token count in collection (40%)
   - Collection engagement score (30%)
   - Featured status (20%)
   - Recent activity (10%)

3. **Full Seaport Schema**: We use the complete Seaport schema from the integration plan rather than a simplified version, allowing for future features (listings, auctions, bundles) without refactoring.

4. **Redis Counters + Database Sync**: View counts are tracked in Redis for real-time updates, then periodically synced to the database for persistence and analytics.

## Database Schema

### Core Tables

#### collections
- `id` (UUID, PK)
- `contract_address` (TEXT, UNIQUE)
- `name` (TEXT)
- `token_type` ('ERC721' | 'ERC1155')
- `total_supply` (INTEGER, nullable)
- `verified` (BOOLEAN)
- `featured` (BOOLEAN) - NEW: Admin can feature collections
- `seaport_enabled` (BOOLEAN) - NEW: Enable Seaport trading
- `royalty_percentage` (INTEGER) - NEW: Basis points (0-10000)
- `royalty_recipient` (TEXT) - NEW: Royalty recipient address
- `last_refresh_at` (TIMESTAMP)
- `refresh_cooldown_until` (TIMESTAMP)
- `created_at`, `updated_at` (TIMESTAMP)

#### nfts
- `id` (UUID, PK)
- `collection_id` (UUID, FK -> collections)
- `token_id` (TEXT)
- `title`, `description` (TEXT, nullable)
- `image_url`, `thumbnail_url` (TEXT, nullable)
- `metadata`, `attributes`, `media` (JSONB, nullable)
- `owner_address` (TEXT, nullable)
- `current_listing_id` (UUID, FK -> seaport_orders) - NEW
- `last_offer_amount` (TEXT, nullable) - NEW
- `last_offer_time` (TIMESTAMP, nullable) - NEW
- `last_owner_check_at` (TIMESTAMP)
- `created_at`, `updated_at` (TIMESTAMP)

#### fc_users
- `id` (UUID, PK)
- `fid` (BIGINT, UNIQUE)
- `username`, `display_name` (TEXT)
- `pfp_url` (TEXT)
- `custody_address` (TEXT)
- `verified_addresses` (JSONB) - Array of verified wallet addresses
- `follower_count`, `following_count` (INTEGER)
- `power_badge` (BOOLEAN)
- `score` (INTEGER)
- `profile` (JSONB)
- `created_at`, `updated_at` (TIMESTAMP)

### Ownership Tables

#### nft_ownership
- `id` (UUID, PK)
- `collection_id` (UUID, FK -> collections)
- `token_id` (TEXT)
- `owner_address` (TEXT)
- `last_verified_at` (TIMESTAMP)
- UNIQUE(collection_id, token_id, owner_address)

#### user_collections
- `id` (UUID, PK)
- `user_address` (TEXT)
- `collection_id` (UUID, FK -> collections)
- `token_count` (INTEGER)
- `last_updated_at` (TIMESTAMP)
- UNIQUE(user_address, collection_id)

#### wallet_collection_mapping
- `id` (UUID, PK)
- `wallet_address` (TEXT)
- `collection_address` (TEXT)
- `token_count` (INTEGER)
- `last_owned_at` (TIMESTAMP)
- UNIQUE(wallet_address, collection_address)

### New Tables (December 2024)

#### site_settings
- `id` (UUID, PK)
- `key` (TEXT, UNIQUE) - e.g., 'hero_cta_authenticated', 'hero_cta_unauthenticated'
- `value` (TEXT) - The actual message/content
- `updated_by_fid` (BIGINT, nullable)
- `updated_at`, `created_at` (TIMESTAMP)

#### seaport_orders
- `id` (UUID, PK)
- `order_hash` (TEXT, UNIQUE)
- `offerer_address` (TEXT)
- `fulfiller_address` (TEXT, nullable)
- `order_type` ('listing' | 'offer' | 'auction')
- `status` ('active' | 'fulfilled' | 'cancelled' | 'expired')
- `start_time`, `end_time` (TIMESTAMP)
- `salt` (TEXT)
- `conduit_key`, `zone_hash` (TEXT, nullable)
- `counter` (BIGINT)
- `offer_items` (JSONB) - Array of OfferItem structs
- `consideration_items` (JSONB) - Array of ConsiderationItem structs
- `fc_user_id` (BIGINT, nullable)
- `frame_url` (TEXT, nullable)
- `created_at`, `updated_at`, `fulfilled_at` (TIMESTAMP)

#### seaport_order_items
- `id` (UUID, PK)
- `order_id` (UUID, FK -> seaport_orders)
- `item_type` ('offer' | 'consideration')
- `token_type` (INTEGER) - 0=ETH, 1=ERC20, 2=ERC721, 3=ERC1155
- `token_address` (TEXT, nullable)
- `token_id` (TEXT, nullable)
- `amount`, `start_amount`, `end_amount` (TEXT) - BigNumber as string
- `recipient_address` (TEXT, nullable)
- `collection_id` (UUID, FK -> collections, nullable)
- `nft_id` (UUID, FK -> nfts, nullable)
- `created_at` (TIMESTAMP)

#### seaport_fulfillments
- `id` (UUID, PK)
- `order_id` (UUID, FK -> seaport_orders)
- `fulfiller_address` (TEXT)
- `transaction_hash` (TEXT, UNIQUE)
- `block_number` (BIGINT)
- `gas_used` (BIGINT, nullable)
- `gas_price` (TEXT, nullable)
- `offer_components` (JSONB)
- `consideration_components` (JSONB)
- `created_at` (TIMESTAMP)

#### seaport_notifications
- `id` (UUID, PK)
- `fc_user_id` (BIGINT)
- `order_id` (UUID, FK -> seaport_orders)
- `notification_type` ('offer_received' | 'listing_sold' | 'offer_accepted' | 'auction_ending')
- `message` (TEXT)
- `is_read` (BOOLEAN, default false)
- `created_at` (TIMESTAMP)

#### collection_engagement
- `id` (UUID, PK)
- `collection_id` (UUID, FK -> collections, UNIQUE)
- `view_count_24h` (INTEGER, default 0)
- `view_count_7d` (INTEGER, default 0)
- `view_count_30d` (INTEGER, default 0)
- `last_viewed_at` (TIMESTAMP, nullable)
- `engagement_score` (DECIMAL(10,2), default 0) - Calculated: (24h*1.0) + (7d*0.3) + (30d*0.1)
- `updated_at`, `created_at` (TIMESTAMP)

## API Endpoints

### Homepage & Collections

#### GET /api/collections/featured
Returns featured collections (manually featured first, then algorithmically determined by engagement score).

Query params:
- `limit` (optional, default 20): Number of collections to return

Response:
```json
{
  "collections": [
    {
      "id": "uuid",
      "contract_address": "0x...",
      "name": "Collection Name",
      "featured": true,
      "image_url": null,
      "floor_price": null,
      "volume_24h": null
    }
  ]
}
```

#### GET /api/seaport/trades/recent
Returns recent fulfilled Seaport orders for the latest trades feed.

Query params:
- `limit` (optional, default 20): Number of trades to return

Response:
```json
{
  "trades": [
    {
      "id": "uuid",
      "nft_image_url": "https://...",
      "collection_name": "Collection Name",
      "collection_address": "0x...",
      "token_id": "123",
      "price": "0.1",
      "buyer_address": "0x...",
      "seller_address": "0x...",
      "transaction_hash": "0x...",
      "created_at": "2024-12-20T..."
    }
  ]
}
```

#### POST /api/collection/[contractAddress]/view
Tracks a collection view for engagement metrics. Increments Redis counters and updates database.

No request body required.

Response:
```json
{
  "success": true
}
```

### Notifications

#### GET /api/notifications
Get user notifications (requires authentication).

Query params:
- `limit` (optional, default 50): Number of notifications
- `unread_only` (optional, default false): Filter to unread only

Response:
```json
{
  "notifications": [
    {
      "id": "uuid",
      "notification_type": "offer_received",
      "message": "You received an offer of 0.1 ETH for Collection #123",
      "is_read": false,
      "created_at": "2024-12-20T...",
      "seaport_orders": {
        "id": "uuid",
        "order_hash": "0x...",
        "order_type": "offer"
      }
    }
  ]
}
```

#### GET /api/notifications/unread-count
Get unread notification count for authenticated user.

Response:
```json
{
  "count": 5
}
```

#### POST /api/notifications/[id]/read
Mark a notification as read (requires authentication).

Response:
```json
{
  "success": true
}
```

### Profile & Prioritization

#### GET /api/profile/[fid]/collections
Get user's collections prioritized by engagement score.

Query params:
- `limit` (optional, default 20): Number of collections to return

Response:
```json
{
  "collections": [
    {
      "id": "uuid",
      "contract_address": "0x...",
      "name": "Collection Name",
      "token_count": 5,
      "featured": false,
      "engagement_score": 123.45,
      "priority_score": 67.89
    }
  ]
}
```

Priority score calculation:
```
score = (user_token_count * 0.4) + (collection_engagement_score * 0.3) + (is_featured * 0.2 * 1000) + (recent_activity * 0.1)
```

### Admin

#### GET /api/admin/site-settings
Get all site settings (admin only).

Response:
```json
{
  "hero_cta_authenticated": "Climb the leaderboard!",
  "hero_cta_unauthenticated": "Claim your profile"
}
```

#### POST /api/admin/site-settings
Update a site setting (admin only).

Request body:
```json
{
  "key": "hero_cta_authenticated",
  "value": "New CTA message",
  "updated_by_fid": 12345
}
```

### Seaport

#### POST /api/seaport/offers/create
Create a Seaport offer order. Stores order in database and creates notification for NFT owner.

Request body:
```json
{
  "contractAddress": "0x...",
  "tokenId": "123",
  "offerAmountEth": "0.1",
  "offererAddress": "0x...",
  "durationDays": 7
}
```

Response:
```json
{
  "success": true,
  "orderComponents": { ... },
  "orderHash": "0x...",
  "message": "Offer order created successfully. Please sign the order with your wallet."
}
```

## Caching Strategy

### Cache Layers

#### L1 - Hot Data (5 min TTL)
- Collection metadata
- User profiles
- NFT ownership
- User's top prioritized collections

#### L2 - Warm Data (30 min TTL)
- Collection NFTs (paginated)
- Collection traits
- Collection stats
- Collection engagement scores
- Featured collections

#### L3 - Cold Data (24 hour TTL)
- User collections (full list)
- Wallet NFT contracts
- Historical engagement data

### Redis Counters

Real-time view counts are tracked in Redis with separate counters:
- `such-market:collections:{collectionId}:views:24h` (24h TTL)
- `such-market:collections:{collectionId}:views:7d` (7d TTL)
- `such-market:collections:{collectionId}:views:30d` (30d TTL)

These are periodically synced to the database (recommended: every 5-10 minutes via background job).

### Cache Keys

All cache keys follow the pattern: `{CACHE_APP_NAME}:{category}:{identifier}:{subcategory}`

Examples:
- `such-market:collections:0x123:metadata`
- `such-market:users:12345:prioritized_collections`
- `such-market:collections:engagement:uuid-123`

## Frontend Components

### Homepage Components

#### Hero (`src/components/homepage/Hero.tsx`)
- Dynamic CTA based on auth state
- Fetches admin-configurable messages from `/api/admin/site-settings`
- Shows "Claim your profile" for unauthenticated, "Climb the leaderboard!" for authenticated (or admin-set messages)

#### FeaturedCollections (`src/components/homepage/FeaturedCollections.tsx`)
- Grid of collection cards
- Fetches from `/api/collections/featured`
- Shows collection image, name, floor price, volume
- Clickable cards linking to collection pages

#### LatestTrades (`src/components/homepage/LatestTrades.tsx`)
- List of recent trades
- Fetches from `/api/seaport/trades/recent`
- Shows NFT image, collection name, price, buyer/seller, timestamp
- Clickable items linking to NFT pages

### Navigation

#### TopNavigation (`src/components/TopNavigation.tsx`)
- Home button (left)
- Notifications bell with unread count badge (right, authenticated only)
- Profile link with user PFP (right, authenticated)
- Sign in button (right, unauthenticated)

#### NotificationsDropdown (`src/components/NotificationsDropdown.tsx`)
- Dropdown menu showing recent notifications
- Unread count badge on bell icon
- Polls for unread count every 30 seconds
- Mark as read functionality
- Click outside to close

### Profile

#### ProfilePage (`src/app/profile/page.tsx`)
- Shows user profile header
- NFT holdings with tabs (to be implemented: Featured, All Collections, Offers Received, Offers Made)
- Uses prioritized collections API for smart loading

## Engagement Tracking

### How It Works

1. **View Tracking**: When a user visits a collection page (`/collection/[contractAddress]`), the page automatically calls `POST /api/collection/[contractAddress]/view`

2. **Redis Counters**: The endpoint increments Redis counters for 24h, 7d, and 30d windows

3. **Database Sync**: A background job (to be implemented) periodically syncs Redis counters to the `collection_engagement` table

4. **Engagement Score**: Calculated as: `(view_count_24h * 1.0) + (view_count_7d * 0.3) + (view_count_30d * 0.1)`

5. **Profile Prioritization**: When loading a user's profile, collections are scored and sorted by priority score

### Why Collection-Level?

- **Scale**: Billions of NFTs exist, but only thousands of collections
- **Better Signals**: Collection popularity is a better indicator than individual NFT views
- **Efficiency**: Much smaller dataset to track and query
- **User Experience**: Users think in terms of collections, not individual NFTs

## Notifications Flow

1. **Offer Created**: When a user creates an offer via `/api/seaport/offers/create`:
   - Order is stored in `seaport_orders`
   - Order items are stored in `seaport_order_items`
   - System looks up NFT owner's Farcaster account
   - If owner has Farcaster account, notification is created in `seaport_notifications`

2. **Notification Display**: 
   - TopNavigation polls `/api/notifications/unread-count` every 30 seconds
   - Badge shows unread count
   - Clicking bell opens NotificationsDropdown
   - Dropdown fetches notifications from `/api/notifications`

3. **Mark as Read**: User can mark notifications as read via `POST /api/notifications/[id]/read`

## File Structure

### Key Files

```
src/
├── app/
│   ├── page.tsx                    # New homepage
│   ├── example/page.tsx            # Farcaster demo (moved from homepage)
│   ├── profile/page.tsx           # User profile with prioritization
│   ├── collection/[contractAddress]/
│   │   └── page.tsx               # Collection page (tracks views)
│   └── api/
│       ├── collections/featured/route.ts
│       ├── seaport/trades/recent/route.ts
│       ├── collection/[contractAddress]/view/route.ts
│       ├── notifications/route.ts
│       ├── notifications/unread-count/route.ts
│       ├── notifications/[id]/read/route.ts
│       ├── profile/[fid]/collections/route.ts
│       ├── admin/site-settings/route.ts
│       └── seaport/offers/create/route.ts  # Updated to store orders & create notifications
├── components/
│   ├── homepage/
│   │   ├── Hero.tsx
│   │   ├── FeaturedCollections.tsx
│   │   └── LatestTrades.tsx
│   ├── TopNavigation.tsx          # Updated with notifications
│   └── NotificationsDropdown.tsx  # New
└── lib/
    ├── db/
    │   └── engagement.ts          # New: Engagement utilities
    └── redis.ts                    # Updated with new cache keys

db/migrations/
├── 0007_add_featured_collections_and_site_settings.sql
├── 0008_create_seaport_orders_and_notifications.sql
└── 0009_create_collection_engagement.sql
```

## Environment Variables

Required environment variables:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `KV_REST_API_URL` (Upstash Redis)
- `KV_REST_API_TOKEN` (Upstash Redis)
- `ALCHEMY_API_KEY`
- `NEXT_PUBLIC_NEYNAR_API_KEY`

## Development Workflow

1. **Run migrations**: `pnpm db:migrate` (or manually run SQL files in `db/migrations/`)
2. **Start dev server**: `pnpm dev`
3. **Access homepage**: `http://localhost:3000`
4. **Access Farcaster demo**: `http://localhost:3000/example`

## Future Enhancements

- Background job to sync Redis counters to database
- Profile tabs: Featured, All Collections, Offers Received, Offers Made
- Admin interface for managing featured collections and site settings
- Collection image URLs in featured collections API
- Floor price and volume calculations from listings/fulfillments
- Like system (if needed) as supplement to engagement tracking
